# 如何给 Daemon 设置代理和 GitHub Token

有些用户可能会希望能直接通过 HTTP/Socks5 代理来加速包下载，或者需要通过 GitHub Token 来访问私有仓库，这里介绍下怎么设置。

直接在 Terminal 中使用 `export HTTPS_PROXY=http://127.0.0.1:7890` 这类方式是无法生效的，因为 nix 实际干活的是一个叫 nix-daemon 的后台进程，而不是直接在 Terminal 中执行的命令。

下面分别介绍给不同平台的 nix-daemon 设置代理和 GitHub Token 的方式。

## 目录

- [给 NixOS 的 nix-daemon 设置代理](#nixos-的-nix-daemon-设置代理)
- [给 Darwin 的 nix-daemon 设置代理](#darwin-的-nix-daemon-设置代理)
- [给 NixOS 的 nix-daemon 设置 GitHub Token](#nixos-的-nix-daemon-设置-github-token)
- [给 Darwin 的 nix-daemon 设置 GitHub Token](#darwin-的-nix-daemon-设置-github-token)
- [给 Home Manager 设置 GitHub Token](#给-home-manager-设置-github-token)
- [验证配置是否生效](#验证配置是否生效)

---

## NixOS 的 nix-daemon 设置代理

通过代理加速包下载，参考了 [Issue: roaming laptop: network proxy configuration](https://github.com/NixOS/nixpkgs/issues/31135)。

### 方法一：临时设置代理（推荐）

如果你只是临时需要使用代理，可以通过以下命令设置：

```bash
sudo mkdir -p /run/systemd/system/nix-daemon.service.d/
sudo tee /run/systemd/system/nix-daemon.service.d/override.conf <<EOF
[Service]
Environment="http_proxy=http://127.0.0.1:7897"
Environment="https_proxy=http://127.0.0.1:7897"
Environment="all_proxy=socks5://127.0.0.1:7897"
EOF
sudo systemctl daemon-reload
sudo systemctl restart nix-daemon
```

**注意**：
- 修改端口 `7897` 为你的实际代理端口
- 如果使用 SOCKS5 代理，使用 `socks5h://` 协议（h 表示通过代理解析 DNS）
- 配置文件位于 `/run/systemd/`，系统重启后会自动删除

### 方法二：永久设置代理（不推荐）

可以在 NixOS 配置中添加：

```nix
# ❌ 不推荐：一旦代理故障，nix-daemon 将无法工作
systemd.services.nix-daemon.environment = {
  http_proxy = "http://127.0.0.1:7897";
  https_proxy = "http://127.0.0.1:7897";
  all_proxy = "socks5://127.0.0.1:7897";
};
```

**为什么不推荐**：
- 代理故障会导致 nix-daemon 无法工作
- systemd 配置文件变为只读，难以修改
- 建议使用方法一或全局代理方案（如 TUN、旁路网关）

---

## Darwin 的 nix-daemon 设置代理

### 方法一：使用脚本注入环境变量（推荐）

在 macOS 上，需要修改 LaunchDaemon 的 plist 文件。创建并运行以下脚本：

```bash
cat << 'EOF' > fix-nix-proxy.sh
#!/bin/bash

PLIST_PATH="/Library/LaunchDaemons/org.nixos.nix-daemon.plist"
PROXY="http://127.0.0.1:7897"  # 修改为你的代理端口

echo "正在从系统提取最新的 nix-daemon 路径..."
DAEMON_PATH=$(/usr/libexec/PlistBuddy -c "Print :ProgramArguments" $PLIST_PATH | grep "/nix/store" | tail -n 1 | sed 's/^[[:space:]]*//')

echo "当前路径为: $DAEMON_PATH"
echo "正在注入代理变量并重启服务..."

sudo launchctl unload $PLIST_PATH

# 删除旧的配置（如果存在）
sudo /usr/libexec/PlistBuddy -c "Delete :EnvironmentVariables" $PLIST_PATH 2>/dev/null

# 添加新的环境变量
sudo /usr/libexec/PlistBuddy -c "Add :EnvironmentVariables dict" $PLIST_PATH
sudo /usr/libexec/PlistBuddy -c "Add :EnvironmentVariables:http_proxy string $PROXY" $PLIST_PATH
sudo /usr/libexec/PlistBuddy -c "Add :EnvironmentVariables:https_proxy string $PROXY" $PLIST_PATH
sudo /usr/libexec/PlistBuddy -c "Add :EnvironmentVariables:all_proxy string socks5://127.0.0.1:7897" $PLIST_PATH
sudo /usr/libexec/PlistBuddy -c "Add :EnvironmentVariables:OBJC_DISABLE_INITIALIZE_FORK_SAFETY string YES" $PLIST_PATH

sudo launchctl load $PLIST_PATH
echo "✅ 代理已注入并重启 nix-daemon"
EOF

chmod +x fix-nix-proxy.sh
./fix-nix-proxy.sh
```

### 方法二：使用 nix-darwin 配置（最推荐）

如果你使用 nix-darwin，可以通过 sops 自动配置，见下文"给 Darwin 的 nix-daemon 设置 GitHub Token"部分。

---

## NixOS 的 nix-daemon 设置 GitHub Token

GitHub Token 用于访问私有仓库和解决 GitHub API 限流问题。

### 方法一：使用 sops-nix 自动配置（推荐）

如果你的配置使用了 `modules/system/sops.nix`，GitHub Token 会自动配置：

```nix
# modules/system/sops.nix
environment.extraInit = ''
  if [ -f "${config.sops.secrets.github_token.path}" ]; then
    export GITHUB_TOKEN="$(cat ${config.sops.secrets.github_token.path})"
    export NIX_CONFIG="extra-access-tokens = github.com=$GITHUB_TOKEN"
  fi
'';
```

### 方法二：手动设置（临时）

```bash
# 临时设置
sudo mkdir -p /run/systemd/system/nix-daemon.service.d/
sudo tee /run/systemd/system/nix-daemon.service.d/override.conf <<EOF
[Service]
Environment="NIX_CONFIG=extra-access-tokens=github.com=YOUR_GITHUB_TOKEN"
EOF
sudo systemctl daemon-reload
sudo systemctl restart nix-daemon
```

### 方法三：通过 nix.settings 配置（永久）

```nix
# configuration.nix
nix.settings = {
  extra-access-tokens = "github.com=YOUR_GITHUB_TOKEN";
};
```

或使用 sops placeholder 自动注入：

```nix
# 使用 sops secrets
nix.settings.extra-access-tokens = "github.com=${config.sops.placeholder.github_token}";
```

---

## Darwin 的 nix-daemon 设置 GitHub Token

### 方法一：使用 nix-darwin + sops 配置（推荐）

在 `modules/darwin/sops.nix` 中，自动为用户配置 GitHub Token：

```nix
# modules/darwin/sops.nix
system.activationScripts.extraActivation.text = ''
  echo "Setting up GitHub access token for nix..."
  if [ -f /run/secrets/github_token ]; then
    TOKEN=$(cat /run/secrets/github_token)
    mkdir -p /Users/${username}/.config/nix
    echo "access-tokens = github.com=$TOKEN" > /Users/${username}/.config/nix/nix.conf
    chown -R ${username}:staff /Users/${username}/.config/nix
    echo "GitHub access token configured in user nix.conf"
  fi
'';
```

### 方法二：手动编辑 nix.conf

```bash
# 创建或编辑 ~/.config/nix/nix.conf
mkdir -p ~/.config/nix
echo "access-tokens = github.com=YOUR_GITHUB_TOKEN" > ~/.config/nix/nix.conf

# 重启 nix-daemon
sudo launchctl unload /Library/LaunchDaemons/org.nixos.nix-daemon.plist
sudo launchctl load /Library/LaunchDaemons/org.nixos.nix-daemon.plist
```

---

## 给 Home Manager 设置 GitHub Token

### 方法一：命令行传递（临时）

```bash
home-manager switch --flake .#vitus@wsl --option "access-tokens" "github.com=YOUR_GITHUB_TOKEN"
```

### 方法二：使用 sops 自动设置（推荐）

在 `home/shell/sops.nix` 中使用模板：

```nix
sops.templates."my-env".content = ''
  export GITHUB_TOKEN="$(cat ${config.sops.secrets.github_token.path})"
  export NIX_CONFIG="extra-access-tokens = github.com=$GITHUB_TOKEN"
'';
```

在 `home/shell/zsh.nix` 中自动加载：

```nix
programs.zsh.initContent = ''
  if [[ -f "${config.xdg.configHome}/sops-nix/secrets/rendered/my-env" ]]; then
    source "${config.xdg.configHome}/sops-nix/secrets/rendered/my-env"
  fi
'';
```

这样每次启动 shell 时，GitHub Token 都会自动加载到环境变量中。

---

## 验证配置是否生效

### 验证代理设置

```bash
# 方法 1：检查 nix-daemon 进程的环境变量
sudo cat /proc/$(pidof nix-daemon)/environ | tr '\0' '\n' | grep -i proxy

# 方法 2：强制从官方源下载包（不走镜像）
nix shell --option substituters "https://cache.nixos.org" nixpkgs#hello --refresh --verbose

# 方法 3：查看当前 substituters
nix show-config | grep substituters
```

**注意**：默认情况下，nix 会使用镜像服务器（如清华镜像、USTC 镜像等）。如果你强制使用官方源，会看到明显的下载速度差异（取决于网络环境）。

### 验证 GitHub Token 设置

```bash
# 检查 nix.conf 配置
cat ~/.config/nix/nix.conf
cat /etc/nix/nix.conf

# 检查环境变量
echo $NIX_CONFIG
echo $GITHUB_TOKEN

# 测试私有仓库访问（如果有私有仓库）
nix registry list
```

---

## 常见问题

### Q: GitHub Token 在哪里获取？

**A**: 访问 https://github.com/settings/tokens，生成新的 Personal Access Token：
1. 点击 "Generate new token" → "Generate new token (classic)"
2. 勾选权限：
   - `repo` - 完整仓库访问权限
   - `read:packages` - 读取包权限
   - `workflow` - 如果需要访问 GitHub Actions
3. 生成后复制 token，它只会显示一次

### Q: 使用代理后仍然遇到 HTTP 403 错误？

**A**: 可能是代理服务器被 GitHub 限制，建议：
1. 更换代理服务器
2. 设置 access-tokens（见上文）
3. 使用 GitHub Token 认证

参考：[nixos-and-flakes-book/issues/74](https://github.com/NixOS/nixos-and-flakes-book/issues/74)

### Q: 如何取消代理设置？

**A**:

**NixOS**:
```bash
sudo rm /run/systemd/system/nix-daemon.service.d/override.conf
sudo systemctl daemon-reload
sudo systemctl restart nix-daemon
```

**Darwin**:
```bash
sudo /usr/libexec/PlistBuddy -c "Delete :EnvironmentVariables" /Library/LaunchDaemons/org.nixos.nix-daemon.plist
sudo launchctl unload /Library/LaunchDaemons/org.nixos.nix-daemon.plist
sudo launchctl load /Library/LaunchDaemons/org.nixos.nix-daemon.plist
```

### Q: sops-nix 生成的 secret 在哪里？

**A**:
- **NixOS (system)**: `/run/secrets/` - 系统级 secrets
- **Darwin (system)**: `/run/secrets/` - 系统级 secrets
- **Home Manager**: `$XDG_RUNTIME_DIR/secrets.d/` 或 `$HOME/.config/sops-nix/secrets/` - 用户级 secrets

### Q: 代理和 GitHub Token 可以同时使用吗？

**A**: 可以，而且推荐同时使用：
- 代理负责加速包下载（substituters）
- GitHub Token 负责 GitHub 认证和私有仓库访问

两者配合使用可以获得最佳体验。

### Q: WSL 环境如何设置代理？

**A**: WSL 可以直接在 Windows 层面设置代理，然后在 WSL 中访问：

```bash
# 在 ~/.bashrc 或 ~/.zshrc 中添加
export http_proxy="http://$(cat /etc/resolv.conf | grep nameserver | awk '{print $2}'):7897"
export https_proxy="http://$(cat /etc/resolv.conf | grep nameserver | awk '{print $2}'):7897"
```

或者直接使用 Windows 主机 IP（通常是 `172.x.x.1`）。

---

## 相关文档

- [NixOS 手册 - Configuration](https://nixos.org/manual/nix/stable/configuration/)
- [sops-nix GitHub](https://github.com/Mic92/sops-nix)
- [nix-darwin GitHub](https://github.com/LnL7/nix-darwin)
- [Home Manager Manual](https://nix-community.github.io/home-manager/)
