# 如何给Daemon设置代理

有些用户可能会希望能直接通过 HTTP/Socks5 代理来加速包下载，这里介绍下怎么设置。

直接在 Terminal 中使用 export HTTPS_PROXY=http://127.0.0.1:7890 这类方式是无法生效的，因为 nix 实际干活的是一个叫 nix-daemon 的后台进程，而不是直接在 Terminal 中执行的命令。

所以下面分别介绍现在可行的给 nix-daemon 设置代理的方式和给 darwin 下的 nix-daemon 设置代理的方式

### nix-daemon

通过代理加速包下载
参考了 Issue: roaming laptop: network proxy configuration - NixOS/nixpkgs

如果你只是临时需要使用代理，可以通过如下命令设置代理环境变量：

```

sudo mkdir -p /run/systemd/system/nix-daemon.service.d/
sudo tee /run/systemd/system/nix-daemon.service.d/override.conf <<EOF
[Service]
Environment="https_proxy=socks5h://localhost:7891"
EOF
sudo systemctl daemon-reload
sudo systemctl restart nix-daemon

```

部署此配置后，可通过

```
 sudo cat /proc/$(pidof nix-daemon)/environ | tr '\0' '\n'
```

查看 nix-daemon 进程的所有环境变量，确认环境变量的设置是否生效。

位于 /run/systemd/system/nix-daemon.service.d/override.conf 的设置会在系统重启后被自动删除，或者你可以手动删除它并重启 nix-daemon 服务来恢复原始设置。

如果你希望永久设置代理，建议将上述命令保存为 shell 脚本，在每次启动系统时运行一下。或者也可以使用旁路网关或 TUN 等全局代理方案。

社区也有人通过 systemd.services.nix-daemon.environment 以声明式的方式为 nix-daemon 永久设置代理，但这种做法下一旦代理出了问题会非常麻烦，nix-daemon 将无法正常工作，进而导致大多数 nix 命令无法正常运行，而且 systemd 自身的配置被设置了只读保护，无法简单地修改配置删除代理设置。因此不建议使用这种方式。

使用一些商用代理或公共代理时你可能会遇到 GitHub 下载时报 HTTP 403 错误（nixos-and-flakes-book/issues/74），可尝试通过更换代理服务器或者设置 access-tokens 来解决。

### darwin下nix-daemon



输入以下命令

```
cat << 'EOF' > fix-nix-proxy.sh
#!/bin/bash

PLIST_PATH="/Library/LaunchDaemons/org.nixos.nix-daemon.plist"
PROXY="http://127.0.0.1:7897" # 确认这是你的代理端口

echo "正在从系统提取最新的 nix-daemon 路径..."
# 动态提取当前存在的 ProgramArguments 路径
DAEMON_PATH=$(/usr/libexec/PlistBuddy -c "Print :ProgramArguments" $PLIST_PATH | grep "/nix/store" | tail -n 1 | sed 's/^[[:space:]]*//')

echo "当前路径为: $DAEMON_PATH"

echo "正在注入代理变量并重启服务..."
sudo launchctl unload $PLIST_PATH

# 注入环境变量
sudo /usr/libexec/PlistBuddy -c "Delete :EnvironmentVariables" $PLIST_PATH 2>/dev/null
sudo /usr/libexec/PlistBuddy -c "Add :EnvironmentVariables dict" $PLIST_PATH
sudo /usr/libexec/PlistBuddy -c "Add :EnvironmentVariables:http_proxy string $PROXY" $PLIST_PATH
sudo /usr/libexec/PlistBuddy -c "Add :EnvironmentVariables:https_proxy string $PROXY" $PLIST_PATH
sudo /usr/libexec/PlistBuddy -c "Add :EnvironmentVariables:OBJC_DISABLE_INITIALIZE_FORK_SAFETY string YES" $PLIST_PATH

sudo launchctl load $PLIST_PATH
echo "✅ 搞定！代理已注入。"
EOF

chmod +x fix-nix-proxy.sh
./fix-nix-proxy.sh
```





检验是否走官方源

```
nix shell --option substituters "https://cache.nixos.org" nixpkgs#hello --refresh --verbose
```

这个命令会强制走官方服务器下载包，如果按照默认方式下包的话他会直接走镜像服务器而不是官方服务器下包

### home-manager
```
home-manager switch --flake .#vitus@wsl --option "access-tokens" "github.com=<github_token>"
```